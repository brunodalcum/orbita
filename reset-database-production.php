<?php

/**
 * SCRIPT DE RESET DO BANCO DE DADOS - PRODU√á√ÉO
 * 
 * ‚ö†Ô∏è  ATEN√á√ÉO: ESTE SCRIPT APAGA TODOS OS DADOS DO BANCO!
 * 
 * Mant√©m apenas:
 * - Super Admin: brunodalcum@dspay.com.br
 * - Estrutura das tabelas
 * - Dados essenciais do sistema
 */

// ========================================
// CONFIGURA√á√ïES DE SEGURAN√áA
// ========================================

// Verifica√ß√£o de ambiente (descomente para produ√ß√£o)
// if (env('APP_ENV') !== 'production') {
//     die("‚ùå ERRO: Este script s√≥ pode ser executado em produ√ß√£o!\n");
// }

// Verifica√ß√£o de confirma√ß√£o obrigat√≥ria
$confirmationKey = 'RESET_PRODUCTION_DATABASE_CONFIRMED_2025';
$providedKey = $argv[1] ?? '';

if ($providedKey !== $confirmationKey) {
    echo "üö® SCRIPT DE RESET DO BANCO DE DADOS - PRODU√á√ÉO üö®\n";
    echo "‚ö†Ô∏è  ATEN√á√ÉO: Este script ir√° APAGAR TODOS OS DADOS!\n\n";
    echo "üìã O que ser√° mantido:\n";
    echo "   ‚úÖ Super Admin: brunodalcum@dspay.com.br\n";
    echo "   ‚úÖ Estrutura das tabelas\n";
    echo "   ‚úÖ Roles e permiss√µes b√°sicas\n\n";
    echo "üìã O que ser√° APAGADO:\n";
    echo "   ‚ùå Todos os usu√°rios (exceto Super Admin)\n";
    echo "   ‚ùå Todas as opera√ß√µes\n";
    echo "   ‚ùå Todos os white labels\n";
    echo "   ‚ùå Todos os licenciados\n";
    echo "   ‚ùå Todos os leads\n";
    echo "   ‚ùå Todos os contratos\n";
    echo "   ‚ùå Toda a agenda\n";
    echo "   ‚ùå Todos os estabelecimentos\n";
    echo "   ‚ùå Todos os dados de branding personalizados\n";
    echo "   ‚ùå TODOS OS OUTROS DADOS\n\n";
    echo "üîê Para executar, use:\n";
    echo "   php reset-database-production.php $confirmationKey\n\n";
    echo "‚ö†Ô∏è  CERTIFIQUE-SE DE TER UM BACKUP ANTES DE EXECUTAR!\n";
    exit(1);
}

// Segunda confirma√ß√£o interativa
echo "üö® CONFIRMA√á√ÉO FINAL üö®\n";
echo "Voc√™ est√° prestes a APAGAR TODOS OS DADOS do banco de produ√ß√£o!\n";
echo "Digite 'SIM APAGAR TUDO' para confirmar: ";
$handle = fopen("php://stdin", "r");
$confirmation = trim(fgets($handle));
fclose($handle);

if ($confirmation !== 'SIM APAGAR TUDO') {
    echo "‚ùå Opera√ß√£o cancelada pelo usu√°rio.\n";
    exit(1);
}

// ========================================
// INICIALIZA√á√ÉO DO LARAVEL
// ========================================

require_once __DIR__ . '/vendor/autoload.php';
$app = require_once __DIR__ . '/bootstrap/app.php';
$app->make(Illuminate\Contracts\Console\Kernel::class)->bootstrap();

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Hash;
use App\Models\User;
use App\Models\Role;
use App\Models\Permission;

echo "\nüöÄ INICIANDO RESET DO BANCO DE DADOS...\n\n";

try {
    // ========================================
    // BACKUP DO SUPER ADMIN
    // ========================================
    
    echo "üìã 1. Fazendo backup do Super Admin...\n";
    
    $superAdmin = DB::table('users')
        ->where('email', 'brunodalcum@dspay.com.br')
        ->first();
    
    if (!$superAdmin) {
        echo "‚ùå ERRO: Super Admin n√£o encontrado!\n";
        echo "   Criando Super Admin...\n";
        
        // Buscar ou criar role de Super Admin
        $superAdminRole = DB::table('roles')->where('name', 'super_admin')->first();
        if (!$superAdminRole) {
            $roleId = DB::table('roles')->insertGetId([
                'name' => 'super_admin',
                'display_name' => 'Super Administrador',
                'description' => 'Acesso total ao sistema',
                'created_at' => now(),
                'updated_at' => now()
            ]);
        } else {
            $roleId = $superAdminRole->id;
        }
        
        $superAdminData = [
            'name' => 'Bruno Dalcum',
            'email' => 'brunodalcum@dspay.com.br',
            'email_verified_at' => now(),
            'password' => Hash::make('123456789'), // Senha padr√£o
            'role_id' => $roleId,
            'node_type' => 'super_admin',
            'is_active' => true,
            'hierarchy_level' => 0,
            'parent_id' => null,
            'created_at' => now(),
            'updated_at' => now()
        ];
    } else {
        $superAdminData = [
            'name' => $superAdmin->name,
            'email' => $superAdmin->email,
            'email_verified_at' => $superAdmin->email_verified_at,
            'password' => $superAdmin->password,
            'role_id' => $superAdmin->role_id,
            'node_type' => 'super_admin',
            'is_active' => true,
            'hierarchy_level' => 0,
            'parent_id' => null,
            'created_at' => $superAdmin->created_at,
            'updated_at' => now()
        ];
    }
    
    echo "‚úÖ Backup do Super Admin realizado.\n\n";
    
    // ========================================
    // DESABILITAR VERIFICA√á√ïES DE CHAVE ESTRANGEIRA
    // ========================================
    
    echo "üîß 2. Desabilitando verifica√ß√µes de chave estrangeira...\n";
    DB::statement('SET FOREIGN_KEY_CHECKS=0;');
    echo "‚úÖ Verifica√ß√µes desabilitadas.\n\n";
    
    // ========================================
    // LIMPEZA DAS TABELAS
    // ========================================
    
    echo "üóëÔ∏è  3. Limpando tabelas do banco de dados...\n";
    
    $tablesToClean = [
        // Tabelas de dados de usu√°rios e hierarquia
        'users',
        'orbita_operacaos',
        'white_labels',
        'licenciados',
        
        // Tabelas de neg√≥cio
        'leads',
        'lead_follow_ups',
        'contracts',
        'contract_documents',
        'contract_audit_logs',
        'agenda',
        'agenda_confirmacaos',
        'agenda_notifications',
        'estabelecimentos',
        'campanhas',
        'email_modelos',
        
        // Tabelas de branding e configura√ß√µes
        'node_branding',
        'node_domains',
        'node_permissions',
        
        // Tabelas de auditoria e logs
        'audit_logs',
        'hierarchy_notifications',
        'reminders',
        'user_reminder_settings',
        
        // Tabelas de extra√ß√£o e places
        'places',
        'place_extractions',
        
        // Tabelas de sess√µes e jobs
        'sessions',
        'jobs',
        'job_batches',
        'failed_jobs',
        
        // Tabelas de cache
        'cache',
        'cache_locks'
    ];
    
    foreach ($tablesToClean as $table) {
        try {
            $count = DB::table($table)->count();
            DB::table($table)->truncate();
            echo "   ‚úÖ $table ($count registros removidos)\n";
        } catch (Exception $e) {
            echo "   ‚ö†Ô∏è  $table (tabela n√£o existe ou erro: " . $e->getMessage() . ")\n";
        }
    }
    
    echo "\n‚úÖ Limpeza das tabelas conclu√≠da.\n\n";
    
    // ========================================
    // RECRIAR SUPER ADMIN
    // ========================================
    
    echo "üëë 4. Recriando Super Admin...\n";
    
    $superAdminId = DB::table('users')->insertGetId($superAdminData);
    
    echo "‚úÖ Super Admin recriado com ID: $superAdminId\n";
    echo "   üìß Email: brunodalcum@dspay.com.br\n";
    echo "   üîë Senha: 123456789\n\n";
    
    // ========================================
    // RECRIAR ROLES E PERMISS√ïES B√ÅSICAS
    // ========================================
    
    echo "üõ°Ô∏è  5. Recriando roles e permiss√µes b√°sicas...\n";
    
    $roles = [
        [
            'name' => 'super_admin',
            'display_name' => 'Super Administrador',
            'description' => 'Acesso total ao sistema'
        ],
        [
            'name' => 'admin',
            'display_name' => 'Administrador',
            'description' => 'Administrador geral'
        ],
        [
            'name' => 'operacao',
            'display_name' => 'Opera√ß√£o',
            'description' => 'Usu√°rio de opera√ß√£o'
        ],
        [
            'name' => 'white_label',
            'display_name' => 'White Label',
            'description' => 'Usu√°rio white label'
        ],
        [
            'name' => 'licenciado',
            'display_name' => 'Licenciado',
            'description' => 'Usu√°rio licenciado'
        ]
    ];
    
    foreach ($roles as $role) {
        try {
            DB::table('roles')->insert([
                'name' => $role['name'],
                'display_name' => $role['display_name'],
                'description' => $role['description'],
                'created_at' => now(),
                'updated_at' => now()
            ]);
            echo "   ‚úÖ Role: {$role['name']}\n";
        } catch (Exception $e) {
            echo "   ‚ö†Ô∏è  Role {$role['name']} j√° existe ou erro\n";
        }
    }
    
    // Permiss√µes b√°sicas
    $permissions = [
        'users.view', 'users.create', 'users.update', 'users.delete',
        'hierarchy.view', 'hierarchy.manage', 'hierarchy.create',
        'contracts.view', 'contracts.create', 'contracts.manage',
        'leads.view', 'leads.create', 'leads.manage',
        'agenda.view', 'agenda.create', 'agenda.manage',
        'branding.view', 'branding.manage'
    ];
    
    foreach ($permissions as $permission) {
        try {
            DB::table('permissions')->insert([
                'name' => $permission,
                'display_name' => ucfirst(str_replace('.', ' ', $permission)),
                'description' => 'Permiss√£o para ' . $permission,
                'created_at' => now(),
                'updated_at' => now()
            ]);
            echo "   ‚úÖ Permiss√£o: $permission\n";
        } catch (Exception $e) {
            echo "   ‚ö†Ô∏è  Permiss√£o $permission j√° existe ou erro\n";
        }
    }
    
    echo "\n‚úÖ Roles e permiss√µes recriadas.\n\n";
    
    // ========================================
    // REABILITAR VERIFICA√á√ïES DE CHAVE ESTRANGEIRA
    // ========================================
    
    echo "üîß 6. Reabilitando verifica√ß√µes de chave estrangeira...\n";
    DB::statement('SET FOREIGN_KEY_CHECKS=1;');
    echo "‚úÖ Verifica√ß√µes reabilitadas.\n\n";
    
    // ========================================
    // LIMPEZA DE ARQUIVOS
    // ========================================
    
    echo "üóÇÔ∏è  7. Limpando arquivos de upload...\n";
    
    $uploadDirs = [
        'storage/app/public/branding',
        'storage/app/public/contracts',
        'storage/app/public/uploads',
        'storage/app/public/documents'
    ];
    
    foreach ($uploadDirs as $dir) {
        if (is_dir($dir)) {
            $files = glob($dir . '/*');
            foreach ($files as $file) {
                if (is_file($file) && !str_contains($file, 'orbita')) {
                    unlink($file);
                }
            }
            echo "   ‚úÖ $dir limpo\n";
        }
    }
    
    echo "\n‚úÖ Arquivos de upload limpos.\n\n";
    
    // ========================================
    // FINALIZA√á√ÉO
    // ========================================
    
    echo "üéâ RESET DO BANCO DE DADOS CONCLU√çDO COM SUCESSO!\n\n";
    echo "üìã RESUMO:\n";
    echo "   ‚úÖ Todas as tabelas foram limpas\n";
    echo "   ‚úÖ Super Admin recriado: brunodalcum@dspay.com.br\n";
    echo "   ‚úÖ Senha padr√£o: 123456789\n";
    echo "   ‚úÖ Roles e permiss√µes b√°sicas recriadas\n";
    echo "   ‚úÖ Arquivos de upload limpos\n\n";
    echo "üöÄ PR√ìXIMOS PASSOS:\n";
    echo "   1. Fa√ßa login com: brunodalcum@dspay.com.br / 123456789\n";
    echo "   2. Altere a senha do Super Admin\n";
    echo "   3. Configure o branding da √ìrbita\n";
    echo "   4. Comece a cadastrar opera√ß√µes e white labels\n\n";
    echo "‚ö†Ô∏è  LEMBRE-SE: Altere a senha padr√£o imediatamente!\n";
    
} catch (Exception $e) {
    echo "‚ùå ERRO DURANTE O RESET:\n";
    echo "   Mensagem: " . $e->getMessage() . "\n";
    echo "   Arquivo: " . $e->getFile() . "\n";
    echo "   Linha: " . $e->getLine() . "\n\n";
    echo "üîß Reabilitando verifica√ß√µes de chave estrangeira...\n";
    DB::statement('SET FOREIGN_KEY_CHECKS=1;');
    echo "‚ùå Reset interrompido. Verifique o erro e tente novamente.\n";
    exit(1);
}

echo "‚úÖ Script finalizado com sucesso!\n";
